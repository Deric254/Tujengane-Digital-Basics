<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KNEC — Online Exam (Training Demo)</title>
<style>
  :root{
    --bg:#f4f6f8; --panel:#ffffff; --knc:#004a99; --accent:#d19a0c; --muted:#6b7280; --dark:#0b1220;
  }
  *{box-sizing:border-box;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#e9eef6 0%, #f4f6f8 100%);color:var(--dark);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
  .wrap{width:100%;max-width:980px;background:var(--panel);border-radius:8px;box-shadow:0 8px 28px rgba(9,30,66,0.08);overflow:hidden}
  header{display:flex;align-items:center;gap:16px;padding:18px 22px;background:linear-gradient(90deg, rgba(0,74,153,0.06), transparent)}
  .knc-mark{width:56px;height:56px;border-radius:6px;background:linear-gradient(180deg,var(--knc),#123e6b);display:grid;place-items:center;color:#fff;font-weight:800}
  .title{font-size:16px;margin:0}
  .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
  .head-right{margin-left:auto;text-align:right;font-size:13px;color:var(--muted)}
  main{display:flex;gap:20px;padding:18px}
  .left{flex:1;min-width:320px}
  .panel{background:transparent;padding:12px}
  .card{background:#fff;border-radius:6px;padding:14px;box-shadow:0 2px 6px rgba(11,18,32,0.04);border:1px solid rgba(11,18,32,0.03)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:6px;border:1px solid #e6e9ee;background:#fbfdff}
  button{cursor:pointer;border:0;padding:10px 14px;border-radius:6px;background:var(--knc);color:#fff;font-weight:600}
  .btn-secondary{background:#f3f8ff;color:var(--knc);border:1px solid #d1e1f7}
  .btn-warn{background:#ffefcf;color:#a35700;border:1px solid #ffe0a1}
  .btn-small{padding:6px 10px;font-size:12px}
  .muted{color:var(--muted);font-size:13px}
  .exam-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .timer-box{display:flex;align-items:center;gap:12px}
  .time{background:#f3f8ff;border:1px solid rgba(0,74,153,0.06);padding:8px 12px;border-radius:6px;font-weight:700;color:var(--knc)}
  .progress{margin-top:12px;height:8px;background:#eef3fb;border-radius:999px;overflow:hidden}
  .progbar{height:100%;background:linear-gradient(90deg,var(--knc),var(--accent));width:0%}
  .question{margin-top:12px}
  .question h3{margin:0;font-size:15px}
  .choices{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .choice{display:flex;align-items:center;gap:10px;padding:10px;border-radius:6px;border:1px solid #eef3fb;background:#fbfdff;cursor:pointer}
  .choice input{transform:scale(1.1)}
  .controls{display:flex;justify-content:space-between;gap:10px;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(44px,1fr));gap:8px;margin-top:10px}
  .grid button{padding:8px;border-radius:6px;border:1px solid #e6e9ee;background:#fff}
  .grid button.answered{background:linear-gradient(90deg,var(--knc),var(--accent));color:#fff;border:0}
  .grid button.flagged{background:#fff;color:#a35700;border:2px solid var(--accent)}
  .grid button.flagged.answered{background:linear-gradient(45deg,var(--knc),var(--accent));color:#fff;border:0}
  .receipt{padding:12px;border-radius:6px;background:#fff;border:1px solid #eef3fb}
  .center{display:grid;place-items:center;padding:28px}
  .steps{display:flex;justify-content:space-between;margin-bottom:20px;position:relative}
  .steps:after{content:'';position:absolute;top:14px;left:0;right:0;height:2px;background:#eef3fb;z-index:1}
  .step{background:#fff;border:2px solid #eef3fb;width:30px;height:30px;border-radius:50%;display:grid;place-items:center;z-index:2;font-size:14px;font-weight:600;color:var(--muted)}
  .step.active{background:var(--knc);color:#fff;border-color:var(--knc)}
  .step.done{background:var(--accent);color:#fff;border-color:var(--accent)}
  .warning-bar{padding:4px 8px;background:#ffefcf;color:#a35700;font-size:12px;text-align:center}
  .security-badge{display:flex;align-items:center;gap:6px;background:#f3f8ff;padding:6px 10px;border-radius:4px;font-size:12px;color:var(--knc)}
  .security-badge.secure:before{content:'✓';font-weight:bold}
  .security-badge.alert{background:#ffefcf;color:#a35700}
  .security-badge.alert:before{content:'!';font-weight:bold}
  .fullscreen-notice{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;text-align:center}
  .fullscreen-notice.visible{display:flex}
  .text-input{background:#fff;border:1px solid #eef3fb;padding:8px;border-radius:6px;min-height:80px;width:100%}
  .section-nav{display:flex;gap:10px;margin-top:12px;border-bottom:1px solid #eef3fb;padding-bottom:12px}
  .section-nav button{background:transparent;color:var(--muted);border:1px solid #eef3fb;padding:8px 12px}
  .section-nav button.active{background:var(--knc);color:#fff;border:none}
  .loader{width:40px;height:40px;border:4px solid #eef3fb;border-top-color:var(--knc);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @media (max-width:880px){ main{flex-direction:column} .head-right{text-align:left} }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-labelledby="apptitle">
    <header>
      <div class="knc-mark" aria-hidden="true">KNEC</div>
      <div>
        <h1 id="apptitle" class="title">KNEC — Online Exam (Training)</h1>
        <div class="subtitle">Kenya National Examinations Council — Invigilator Training Demo</div>
      </div>
      <div class="head-right">
        <div id="session" style="font-weight:700">PRIMARY 4 — ENGLISH PAPER 1</div>
        <div class="muted" style="margin-top:4px">Training copy — NOT connected to KNEC systems</div>
      </div>
    </header>

    <div class="warning-bar" id="warning-message"></div>

    <main>
      <section class="left">
        <!-- STEP INDICATOR -->
        <div class="steps" id="step-indicator">
          <div class="step active" id="step1">1</div>
          <div class="step" id="step2">2</div>
          <div class="step" id="step3">3</div>
          <div class="step" id="step4">4</div>
          <div class="step" id="step5">5</div>
        </div>

        <!-- 1. SYSTEM CHECK -->
        <div id="systemCheckCard" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">System Check</div>
              <div class="muted" style="margin-top:6px">Verifying your system compatibility with KNEC exam environment.</div>
            </div>
          </div>

          <div style="margin-top:18px">
            <div class="security-badge secure" id="browser-check">Browser compatibility check</div>
            <div class="security-badge secure" id="network-check" style="margin-top:8px">Network connectivity check</div>
            <div class="security-badge secure" id="screen-check" style="margin-top:8px">Screen resolution check</div>
            <div class="security-badge secure" id="plugins-check" style="margin-top:8px">Browser plugins check</div>
            
            <div style="margin-top:20px;display:flex;justify-content:space-between;">
              <div class="muted">Please wait while we verify your system...</div>
              <div>
                <div class="loader" id="system-loader"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. INVIGILATOR VERIFICATION -->
        <div id="invigilatorCard" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Invigilator Verification</div>
              <div class="muted" style="margin-top:6px">Invigilator must verify candidate identity before proceeding.</div>
            </div>
          </div>

          <div style="margin-top:18px">
            <div style="padding:12px;border:1px dashed #e6e9ee;border-radius:6px;margin-bottom:16px">
              <div style="font-weight:600">Invigilator Instructions:</div>
              <ol style="margin-top:6px;padding-left:20px;color:var(--muted);font-size:13px">
                <li>Verify candidate ID matches the attendance register</li>
                <li>Confirm candidate photo matches the person present</li>
                <li>Ensure candidate is seated at the assigned station</li>
                <li>Enter your invigilator PIN to authorize exam start</li>
              </ol>
            </div>

            <label for="invPin">Invigilator PIN</label>
            <div style="display:flex;gap:12px">
              <input id="invPin" type="password" placeholder="Enter 6-digit PIN" maxlength="6" />
              <button id="verifyPin">Verify</button>
            </div>
          </div>
        </div>

        <!-- 3. CANDIDATE LOGIN -->
        <div id="loginCard" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Candidate Login</div>
              <div class="muted" style="margin-top:6px">Type candidate details exactly as on the attendance list.</div>
            </div>
            <div class="muted" style="font-size:13px">Exam duration: <strong id="durLabel">30 min</strong></div>
          </div>

          <div style="margin-top:12px">
            <label for="candName">Candidate name</label>
            <input id="candName" type="text" placeholder="Full name" autocomplete="off" />

            <div style="display:flex;gap:12px;margin-top:10px">
              <div style="flex:1">
                <label for="candReg">Index number</label>
                <input id="candReg" type="text" placeholder="e.g. 1234567" />
              </div>
              <div style="width:160px;align-self:end">
                <button id="startBtn" style="width:100%">Start Exam</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 4. INSTRUCTIONS -->
        <div id="instructionsCard" class="card" style="display:none">
          <div style="font-weight:700">Exam Instructions</div>
          <div class="muted" style="margin-top:6px" id="examInstructions">Please read these instructions carefully before beginning.</div>

          <div style="margin-top:14px;padding:14px;border-radius:6px;background:#f9fafc">
            <h3 style="margin:0;font-size:15px">PRIMARY 4 — ENGLISH PAPER 1</h3>
            
            <ol style="margin-top:10px;padding-left:20px;color:var(--dark)">
              <li>This paper contains <strong>20 multiple choice questions</strong>. For this demo, we show only 5 questions.</li>
              <li>You have <strong>30 minutes</strong> to complete the paper.</li>
              <li>Answer ALL questions in this paper.</li>
              <li>You can navigate between questions using the Next and Previous buttons.</li>
              <li>You can flag questions to review later by clicking the flag button.</li>
              <li>Your answers are automatically saved when selected.</li>
              <li>Use the question palette on the right to quickly jump to any question.</li>
              <li>Once you click "Submit Paper", you cannot change your answers.</li>
              <li>Do not attempt to leave the exam window or switch to another application.</li>
              <li>If you experience technical issues, raise your hand to alert the invigilator.</li>
            </ol>
          </div>

          <div style="margin-top:18px;display:flex;justify-content:space-between;align-items:center">
            <div class="security-badge secure">Secure exam environment active</div>
            <button id="beginExamBtn">I understand, Begin Exam</button>
          </div>
        </div>

        <!-- 5. EXAM -->
        <div id="examCard" class="card" style="display:none">
          <div class="exam-top">
            <div>
              <div style="font-weight:700" id="examTitle">PRIMARY 4 — ENGLISH PAPER 1</div>
              <div class="muted" id="candInfo">Candidate: — • Index: —</div>
            </div>
            <div class="timer-box">
              <div class="muted" style="font-size:13px">Time remaining</div>
              <div class="time" id="timeLeft">30:00</div>
            </div>
          </div>

          <div class="section-nav" id="section-nav">
            <button class="active" data-section="section1">Section 1: Grammar</button>
            <button data-section="section2">Section 2: Vocabulary</button>
            <button data-section="section3">Section 3: Comprehension</button>
          </div>

          <div class="progress" aria-hidden="true">
            <div class="progbar" id="progbar" style="width:0%"></div>
          </div>

          <div id="questionArea" class="question" aria-live="polite"></div>

          <div class="controls">
            <div>
              <button id="prevBtn" class="btn-secondary btn-small">Previous</button>
              <button id="flagBtn" class="btn-warn btn-small">Flag for Review</button>
              <button id="nextBtn" class="btn-secondary btn-small">Next</button>
            </div>
            <div>
              <button id="submitBtn">Submit Paper</button>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
            <div class="security-badge secure">Auto-save enabled • Do not refresh</div>
            <div class="muted" id="statusCount">Answered: 0 / 0</div>
          </div>
        </div>

        <!-- FINISH - SUBMISSION CONFIRMATION -->
        <div id="confirmSubmitCard" class="card" style="display:none">
          <div style="text-align:center;padding:14px">
            <div style="font-weight:700;font-size:18px">Confirm Submission</div>
            <div class="muted" style="margin:10px 0 18px">Are you sure you want to submit your answers?</div>
            
            <div style="padding:12px;margin:0 auto 18px;max-width:300px;background:#f9fafc;border-radius:6px">
              <div id="confirm-stats" style="text-align:left">
                <div>Total questions: <strong>5</strong></div>
                <div style="margin-top:4px">Answered: <strong id="confirm-answered">0</strong></div>
                <div style="margin-top:4px">Unanswered: <strong id="confirm-unanswered">0</strong></div>
                <div style="margin-top:4px">Flagged for review: <strong id="confirm-flagged">0</strong></div>
              </div>
            </div>
            
            <div style="display:flex;gap:10px;justify-content:center">
              <button id="cancelSubmit" class="btn-secondary">Return to Exam</button>
              <button id="confirmSubmit">Confirm Submission</button>
            </div>
          </div>
        </div>

        <!-- SUBMITTING -->
        <div id="submittingCard" class="card" style="display:none">
          <div class="center" style="padding:30px">
            <div class="loader"></div>
            <div style="margin-top:16px;font-weight:600">Submitting your answers...</div>
            <div class="muted" style="margin-top:8px">Please do not close the browser or refresh the page.</div>
          </div>
        </div>

        <!-- FINISH - RESULTS -->
        <div id="finishCard" class="card" style="display:none">
          <div class="center">
            <div class="receipt" id="receipt" style="width:100%;max-width:400px">
              <div style="font-weight:700;text-align:center;font-size:18px">Submission Accepted</div>
              <div style="text-align:center;margin:10px 0;padding:10px 0;border-bottom:1px solid #eef3fb">
                <div class="muted" id="resInfo">Candidate: — • Index: —</div>
                <div style="margin-top:8px;font-size:14px">Paper: <strong>PRIMARY 4 — ENGLISH PAPER 1</strong></div>
              </div>
              
              <div style="margin-top:14px;text-align:center">
                <div style="font-size:24px">Score: <strong id="resScore">0%</strong></div>
                <div class="muted" id="resSummary" style="margin-top:6px">Correct: 0 • Attempted: 0 • Total: 0</div>
              </div>
              
              <div style="margin-top:20px;display:flex;gap:8px;justify-content:center">
                <button id="printBtn" class="btn-secondary btn-small">Print Receipt</button>
                <button id="reviewBtn" class="btn-small">Review Answers</button>
                <button id="newBtn" class="btn-secondary btn-small">Start New</button>
              </div>
              
              <div class="muted" style="margin-top:16px;font-size:12px;text-align:center;padding-top:10px;border-top:1px solid #eef3fb">
                This is a training copy. For real exams use the official KNEC portal and follow invigilation procedures.
                <div style="margin-top:4px">Submission ID: KNC-<span id="submission-id">2354789</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ANSWER REVIEW -->
        <div id="reviewCard" class="card" style="display:none">
          <div style="font-weight:700">Answer Review</div>
          <div class="muted" style="margin-top:6px">Review of your submitted answers</div>
          
          <div style="margin-top:14px" id="answer-review-area"></div>
          
          <div style="margin-top:16px;display:flex;justify-content:center">
            <button id="backToResultsBtn" class="btn-secondary">Back to Results</button>
          </div>
        </div>
      </section>

      <aside style="width:300px">
        <!-- SYSTEM CHECK SIDEBAR -->
        <div class="card" id="system-check-sidebar">
          <div style="font-weight:700">System Requirements</div>
          <div class="muted" style="margin-top:6px;font-size:12px">The KNEC exam requires:</div>
          <ul style="padding-left:18px;margin-top:8px;color:var(--muted);font-size:13px">
            <li>Modern browser (Chrome/Firefox/Edge)</li>
            <li>Stable internet connection</li>
            <li>Screen resolution at least 1024x768</li>
            <li>No blocked cookies or popups</li>
            <li>No unauthorized extensions</li>
          </ul>
        </div>

        <!-- INVIGILATOR SIDEBAR -->
        <div class="card" id="invigilator-sidebar" style="display:none">
          <div style="font-weight:700">Invigilator Panel</div>
          <div class="muted" style="margin-top:6px;font-size:12px">For training purposes only</div>
          <div style="margin-top:12px;padding:10px;background:#f9fafc;border-radius:6px;font-size:13px">
            <div>Demo PIN: <strong>123456</strong></div>
            <div style="margin-top:4px">Center Code: <strong>KNC-001</strong></div>
            <div style="margin-top:4px">Session ID: <strong>P4-ENG-2023-T1</strong></div>
          </div>
        </div>

        <!-- EXAM SIDEBAR -->
        <div class="card" id="exam-sidebar" style="display:none">
          <div style="font-weight:700">Question Palette</div>
          <div class="muted" style="margin-top:4px;margin-bottom:8px;font-size:12px">
            <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--knc)"></span> Answered
            <span style="display:inline-block;width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);margin-left:8px"></span> Flagged
          </div>
          
          <div class="grid" id="qGrid"></div>

          <div style="margin-top:14px">
            <div style="font-weight:700;font-size:13px">Invigilator checklist</div>
            <ul style="padding-left:18px;margin-top:8px;color:var(--muted);font-size:13px">
              <li>Confirm identity & index number</li>
              <li>Start the candidate and watch the timer</li>
              <li>Allow navigation; do not assist with answers</li>
              <li>Click Submit once when finished</li>
            </ul>
          </div>
          
          <div style="margin-top:14px">
            <div style="font-weight:700;font-size:13px">Exam Security</div>
            <div class="security-badge secure" style="margin-top:8px">Browser locked</div>
            <div class="security-badge secure" style="margin-top:6px">Screen monitoring active</div>
            <div id="focus-alert" class="security-badge secure" style="margin-top:6px">Focus maintained</div>
          </div>
        </div>

        <!-- RESULTS SIDEBAR -->
        <div class="card" id="results-sidebar" style="display:none">
          <div style="font-weight:700">Result Information</div>
          <div class="muted" style="margin-top:6px;font-size:12px">For training purposes only</div>
          <div style="margin-top:12px">
            <div style="padding:10px;background:#f9fafc;border-radius:6px;font-size:13px">
              <div>Session: <strong>P4-ENG-2023-T1</strong></div>
              <div style="margin-top:4px">Date: <strong id="exam-date">Oct 11, 2023</strong></div>
              <div style="margin-top:4px">Duration: <strong>30 minutes</strong></div>
              <div style="margin-top:4px">Status: <strong style="color:#22c55e">Complete</strong></div>
            </div>
            
            <div style="margin-top:14px;padding:10px;background:#f9fafc;border-radius:6px;font-size:13px">
              <div style="font-weight:600">Question Statistics:</div>
              <div style="margin-top:6px">Total Questions: <strong>5</strong></div>
              <div style="margin-top:4px">Answered: <strong id="stats-answered">0</strong></div>
              <div style="margin-top:4px">Correct: <strong id="stats-correct">0</strong></div>
              <div style="margin-top:4px">Incorrect: <strong id="stats-incorrect">0</strong></div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Fullscreen Notice -->
  <div class="fullscreen-notice" id="fullscreen-notice">
    <div style="font-size:24px;margin-bottom:16px">⚠️ Warning: Exam Security</div>
    <div style="font-size:18px;margin-bottom:24px">You have left the secure exam environment!</div>
    <div style="font-size:14px;max-width:400px;text-align:center;margin-bottom:24px">
      In a real KNEC exam, this would be reported to invigilators and may be considered exam malpractice.
      Please return to the exam immediately.
    </div>
    <button id="return-to-exam" style="background:#d19a0c">Return to Exam</button>
  </div>

<script>
/* CONFIG */
const DURATION_MIN = 30; // realistic default
const QUESTIONS = [
  {id:1, section:"section1", q:"1. Who is the President of Kenya?", choices:["William Ruto","Uhuru Kenyatta","Mwai Kibaki","Daniel arap Moi"], answer:0},
  {id:2, section:"section1", q:"2. 7 + 5 = ?", choices:["10","11","12","13"], answer:2},
  {id:3, section:"section2", q:"3. Which of these is a vegetable?", choices:["Banana","Carrot","Mango","Bread"], answer:1},
  {id:4, section:"section2", q:"4. The Sun rises from the _____.", choices:["West","East","North","South"], answer:1},
  {id:5, section:"section3", q:"5. Which animal gives us milk?", choices:["Goat","Lion","Eagle","Snake"], answer:0},
  
  // Text entry question example
  {id:6, section:"section3", q:"6. Write a short sentence using the word 'happy'.", type:"text", answer:"Any sentence containing 'happy'"},
  
  // Image-based question example
  {id:7, section:"section3", q:"7. Look at the image below. What animal is shown?", image:"assets/img/lion.jpg", choices:["Lion","Tiger","Elephant","Giraffe"], answer:0},
];

/* STATE */
let state = {
  step: 1,  // Current step in the exam process
  started: false,
  timeLeft: DURATION_MIN*60,
  current: 0,
  answers: {}, // id -> selected index
  flagged: {}, // id -> true/false
  candidate: '',
  indexNo: '',
  timer: null,
  submitted: false,
  activeSection: 'section1',
  focusLost: 0,
  warningShown: false
};

/* ELEMENTS */
// Cards
const systemCheckCard = document.getElementById('systemCheckCard');
const invigilatorCard = document.getElementById('invigilatorCard');
const loginCard = document.getElementById('loginCard');
const instructionsCard = document.getElementById('instructionsCard');
const examCard = document.getElementById('examCard');
const confirmSubmitCard = document.getElementById('confirmSubmitCard');
const submittingCard = document.getElementById('submittingCard');
const finishCard = document.getElementById('finishCard');
const reviewCard = document.getElementById('reviewCard');

// Sidebars
const systemCheckSidebar = document.getElementById('system-check-sidebar');
const invigilatorSidebar = document.getElementById('invigilator-sidebar');
const examSidebar = document.getElementById('exam-sidebar');
const resultsSidebar = document.getElementById('results-sidebar');

// Steps
const stepIndicators = [
  document.getElementById('step1'),
  document.getElementById('step2'),
  document.getElementById('step3'),
  document.getElementById('step4'),
  document.getElementById('step5')
];

// System check elements
const browserCheck = document.getElementById('browser-check');
const networkCheck = document.getElementById('network-check');
const screenCheck = document.getElementById('screen-check');
const pluginsCheck = document.getElementById('plugins-check');
const systemLoader = document.getElementById('system-loader');

// Invigilator verification
const invPin = document.getElementById('invPin');
const verifyPin = document.getElementById('verifyPin');

// Login elements
const startBtn = document.getElementById('startBtn');
const candName = document.getElementById('candName');
const candReg = document.getElementById('candReg');
const durLabel = document.getElementById('durLabel');

// Instructions elements
const beginExamBtn = document.getElementById('beginExamBtn');

// Exam elements
const timeLeftEl = document.getElementById('timeLeft');
const qArea = document.getElementById('questionArea');
const progbar = document.getElementById('progbar');
const qGrid = document.getElementById('qGrid');
const statusCount = document.getElementById('statusCount');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const flagBtn = document.getElementById('flagBtn');
const submitBtn = document.getElementById('submitBtn');
const sectionNavButtons = document.querySelectorAll('#section-nav button');
const focusAlert = document.getElementById('focus-alert');
const warningMessage = document.getElementById('warning-message');

// Confirm submission elements
const confirmAnswered = document.getElementById('confirm-answered');
const confirmUnanswered = document.getElementById('confirm-unanswered');
const confirmFlagged = document.getElementById('confirm-flagged');
const cancelSubmit = document.getElementById('cancelSubmit');
const confirmSubmit = document.getElementById('confirmSubmit');

// Finish elements
const resInfo = document.getElementById('resInfo');
const resScore = document.getElementById('resScore');
const resSummary = document.getElementById('resSummary');
const submissionId = document.getElementById('submission-id');
const statsAnswered = document.getElementById('stats-answered');
const statsCorrect = document.getElementById('stats-correct');
const statsIncorrect = document.getElementById('stats-incorrect');
const printBtn = document.getElementById('printBtn');
const reviewBtn = document.getElementById('reviewBtn');
const newBtn = document.getElementById('newBtn');

// Review elements
const answerReviewArea = document.getElementById('answer-review-area');
const backToResultsBtn = document.getElementById('backToResultsBtn');

// Fullscreen notice
const fullscreenNotice = document.getElementById('fullscreen-notice');
const returnToExam = document.getElementById('return-to-exam');

// Set exam date
document.getElementById('exam-date').textContent = new Date().toLocaleDateString('en-US', {
  year: 'numeric', 
  month: 'short', 
  day: 'numeric'
});

/* INIT UI */
durLabel.textContent = DURATION_MIN + ' min';
timeLeftEl.textContent = formatTime(state.timeLeft);

// Initialize UI
initializeSystemCheck();

/* UTIL */
function formatTime(s){ 
  const mm = String(Math.floor(s/60)).padStart(2,'0'); 
  const ss = String(s%60).padStart(2,'0'); 
  return mm+':'+ss; 
}

function save(){ 
  const p = {
    step: state.step,
    answers: state.answers,
    flagged: state.flagged,
    timeLeft: state.timeLeft,
    started: state.started,
    candidate: state.candidate,
    indexNo: state.indexNo,
    submitted: state.submitted,
    activeSection: state.activeSection,
    current: state.current
  }; 
  localStorage.setItem('kn_exam_demo',JSON.stringify(p)); 
}

function load(){ 
  try{ 
    const r = JSON.parse(localStorage.getItem('kn_exam_demo')); 
    if(r){ 
      state.step = r.step || 1;
      state.answers = r.answers || {}; 
      state.flagged = r.flagged || {};
      state.timeLeft = ('timeLeft' in r) ? r.timeLeft : state.timeLeft;
      state.started = !!r.started;
      state.candidate = r.candidate || '';
      state.indexNo = r.indexNo || '';
      state.submitted = !!r.submitted;
      state.activeSection = r.activeSection || 'section1';
      state.current = r.current || 0;
    } 
  } catch(e){} 
}

function clearSave(){ localStorage.removeItem('kn_exam_demo'); }

function updateStep(step) {
  state.step = step;
  
  // Update step indicators
  stepIndicators.forEach((indicator, index) => {
    if (index + 1 < step) {
      indicator.classList.remove('active');
      indicator.classList.add('done');
    } else if (index + 1 === step) {
      indicator.classList.add('active');
      indicator.classList.remove('done');
    } else {
      indicator.classList.remove('active', 'done');
    }
  });
  
  // Hide all cards and sidebars
  [systemCheckCard, invigilatorCard, loginCard, instructionsCard, examCard, confirmSubmitCard, submittingCard, finishCard, reviewCard].forEach(card => {
    card.style.display = 'none';
  });
  
  [systemCheckSidebar, invigilatorSidebar, examSidebar, resultsSidebar].forEach(sidebar => {
    sidebar.style.display = 'none';
  });
  
  // Show appropriate card and sidebar based on step
  switch(step) {
    case 1: // System Check
      systemCheckCard.style.display = 'block';
      systemCheckSidebar.style.display = 'block';
      break;
    case 2: // Invigilator Verification
      invigilatorCard.style.display = 'block';
      invigilatorSidebar.style.display = 'block';
      break;
    case 3: // Candidate Login
      loginCard.style.display = 'block';
      invigilatorSidebar.style.display = 'block';
      break;
    case 4: // Instructions
      instructionsCard.style.display = 'block';
      examSidebar.style.display = 'block';
      break;
    case 5: // Exam
      examCard.style.display = 'block';
      examSidebar.style.display = 'block';
      break;
  }
  
  save();
}

/* RENDER */
function renderGrid(){ 
  qGrid.innerHTML = '';
  
  // Filter questions by active section if in exam mode
  const displayQuestions = state.step === 5 
    ? QUESTIONS.filter(q => q.section === state.activeSection || !q.section)
    : QUESTIONS;
  
  displayQuestions.forEach((q, i) => { 
    const btn = document.createElement('button'); 
    btn.textContent = q.id;
    
    if (state.answers[q.id] !== undefined) btn.classList.add('answered');
    if (state.flagged[q.id]) btn.classList.add('flagged');
    
    btn.addEventListener('click', () => { 
      // Find the index in the full QUESTIONS array
      const fullIndex = QUESTIONS.findIndex(question => question.id === q.id);
      state.current = fullIndex;
      state.activeSection = q.section || 'section1';
      updateSectionNav();
      renderQuestion();
    });
    
    qGrid.appendChild(btn); 
  });
  
  updateStatus();
}

function renderQuestion() {
  const q = QUESTIONS[state.current];
  if (!q) return;
  
  qArea.innerHTML = '';
  
  // Question title
  const h = document.createElement('h3');
  h.textContent = q.q;
  qArea.appendChild(h);
  
  // If there's an image
  if (q.image) {
    const img = document.createElement('img');
    img.src = q.image;
    img.alt = 'Question image';
    img.style.maxWidth = '100%';
    img.style.marginTop = '10px';
    img.style.borderRadius = '4px';
    qArea.appendChild(img);
  }
  
  // Question type handling
  if (q.type === 'text') {
    // Text entry question
    const textarea = document.createElement('textarea');
    textarea.className = 'text-input';
    textarea.placeholder = 'Type your answer here...';
    textarea.value = state.answers[q.id] || '';
    textarea.addEventListener('input', () => {
      state.answers[q.id] = textarea.value;
      save();
      renderGrid();
      updateStatus();
    });
    qArea.appendChild(textarea);
  } else {
    // Multiple choice question
    const choices = document.createElement('div');
    choices.className = 'choices';
    
    q.choices.forEach((c, idx) => {
      const lab = document.createElement('label');
      lab.className = 'choice';
      
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'opt';
      radio.value = idx;
      
      if (state.answers[q.id] === idx) radio.checked = true;
      
      radio.addEventListener('change', () => {
        state.answers[q.id] = idx;
        save();
        renderGrid();
        updateStatus();
      });
      
      lab.appendChild(radio);
      const span = document.createElement('span');
      span.textContent = c;
      lab.appendChild(span);
      choices.appendChild(lab);
    });
    
    qArea.appendChild(choices);
  }
  
  // Update flag button state
  if (state.flagged[q.id]) {
    flagBtn.textContent = 'Unflag Question';
    flagBtn.classList.add('btn-warn');
  } else {
    flagBtn.textContent = 'Flag for Review';
    flagBtn.classList.remove('btn-warn');
  }
  
  // Update UI elements
  document.getElementById('examTitle').textContent = 'PRIMARY 4 — ENGLISH PAPER 1';
  document.getElementById('candInfo').textContent = `Candidate: ${state.candidate} • Index: ${state.indexNo}`;
  
  updateStatus();
  updateSectionNav();
}

function updateStatus() {
  // Count total questions per section
  const displayQuestions = state.step === 5 
    ? QUESTIONS.filter(q => q.section === state.activeSection || !q.section)
    : QUESTIONS;
  
  const totalQuestions = displayQuestions.length;
  
  // Count answered questions
  const answeredCount = Object.keys(state.answers).length;
  const displayAnswered = displayQuestions.filter(q => state.answers[q.id] !== undefined).length;
  
  // Update progress bar
  const pct = totalQuestions > 0 ? Math.round(100 * (displayAnswered / totalQuestions)) : 0;
  progbar.style.width = pct + '%';
  
  // Update status text
  statusCount.textContent = `Answered: ${displayAnswered} / ${totalQuestions}`;
  
  // Count flagged questions
  const flaggedCount = Object.keys(state.flagged).filter(id => state.flagged[id]).length;
  
  // Update confirmation stats if visible
  if (confirmSubmitCard.style.display !== 'none') {
    confirmAnswered.textContent = answeredCount;
    confirmUnanswered.textContent = QUESTIONS.length - answeredCount;
    confirmFlagged.textContent = flaggedCount;
  }
}

function updateSectionNav() {
  sectionNavButtons.forEach(button => {
    if (button.dataset.section === state.activeSection) {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  });
}

/* TIMER */
function startTimer() {
  if (state.timer) clearInterval(state.timer);
  state.timer = setInterval(() => {
    if (state.timeLeft <= 0) { 
      clearInterval(state.timer);
      autoSubmit(true);
      return;
    }
    state.timeLeft--;
    timeLeftEl.textContent = formatTime(state.timeLeft);
    save();
  }, 1000);
}

/* INITIALIZATION FUNCTIONS */
function initializeSystemCheck() {
  // Simulate system check process
  setTimeout(() => {
    browserCheck.textContent = "✓ Browser compatibility verified";
    browserCheck.classList.add("secure");
    
    setTimeout(() => {
      networkCheck.textContent = "✓ Network connectivity verified";
      networkCheck.classList.add("secure");
      
      setTimeout(() => {
        screenCheck.textContent = "✓ Screen resolution verified";
        screenCheck.classList.add("secure");
        
        setTimeout(() => {
          pluginsCheck.textContent = "✓ Browser environment verified";
          pluginsCheck.classList.add("secure");
          
          setTimeout(() => {
            systemLoader.style.display = "none";
            const continueBtn = document.createElement("button");
            continueBtn.textContent = "Continue";
            continueBtn.style.marginTop = "20px";
            continueBtn.addEventListener("click", () => {
              updateStep(2); // Move to invigilator verification
            });
            systemLoader.parentNode.appendChild(continueBtn);
          }, 1000);
        }, 800);
      }, 700);
    }, 600);
  }, 1500);
  
  // Initialize the grid for exam preview
  renderGrid();
}

/* EVENT HANDLERS */

// Invigilator verification
verifyPin.addEventListener('click', () => {
  const pin = invPin.value.trim();
  if (pin !== '123456') {
    alert('Invalid PIN. For this demo, use 123456.');
    return;
  }
  
  updateStep(3); // Move to candidate login
});

// Candidate login
startBtn.addEventListener('click', () => {
  const name = candName.value.trim();
  const idx = candReg.value.trim();
  if (!name || !idx) {
    alert('Please type candidate name and index number.');
    return;
  }
  
  state.candidate = name;
  state.indexNo = idx;
  updateStep(4); // Move to instructions
  save();
});

// Begin exam after instructions
beginExamBtn.addEventListener('click', () => {
  state.started = true;
  state.timeLeft = DURATION_MIN * 60;
  updateStep(5); // Move to exam
  renderGrid();
  renderQuestion();
  startTimer();
  save();
  
  // Set up focus monitoring for exam security
  setupFocusMonitoring();
});

// Navigation buttons
prevBtn.addEventListener('click', () => {
  if (state.current > 0) {
    state.current--;
    renderQuestion();
    save();
  }
});

nextBtn.addEventListener('click', () => {
  if (state.current < QUESTIONS.length - 1) {
    state.current++;
    renderQuestion();
    save();
  }
});

// Flag button
flagBtn.addEventListener('click', () => {
  const q = QUESTIONS[state.current];
  state.flagged[q.id] = !state.flagged[q.id];
  renderQuestion();
  renderGrid();
  save();
});

// Section navigation
sectionNavButtons.forEach(button => {
  button.addEventListener('click', () => {
    state.activeSection = button.dataset.section;
    
    // Find first question in this section
    const firstQuestion = QUESTIONS.findIndex(q => q.section === state.activeSection);
    if (firstQuestion >= 0) {
      state.current = firstQuestion;
    }
    
    updateSectionNav();
    renderQuestion();
    renderGrid();
    save();
  });
});

// Submit button
submitBtn.addEventListener('click', () => {
  // Show confirmation dialog
  examCard.style.display = 'none';
  confirmSubmitCard.style.display = 'block';
  
  // Update confirmation stats
  updateStatus();
});

// Cancel submission
cancelSubmit.addEventListener('click', () => {
  confirmSubmitCard.style.display = 'none';
  examCard.style.display = 'block';
});

// Confirm submission
confirmSubmit.addEventListener('click', () => {
  confirmSubmitCard.style.display = 'none';
  submittingCard.style.display = 'block';
  
  // Simulate submission process
  setTimeout(() => {
    submittingCard.style.display = 'none';
    autoSubmit(false);
  }, 2000);
});

// Review answers button
reviewBtn.addEventListener('click', () => {
  renderReviewAnswers();
  finishCard.style.display = 'none';
  reviewCard.style.display = 'block';
});

// Back to results button
backToResultsBtn.addEventListener('click', () => {
  reviewCard.style.display = 'none';
  finishCard.style.display = 'block';
});

// Return to exam from fullscreen warning
returnToExam.addEventListener('click', () => {
  fullscreenNotice.classList.remove('visible');
});

// Print and new exam buttons
printBtn.addEventListener('click', () => window.print());
newBtn.addEventListener('click', () => {
  if (confirm('Start a new session?')) {
    clearSave();
    location.reload();
  }
});

/* FOCUS MONITORING */
function setupFocusMonitoring() {
  // Monitor window focus
  window.addEventListener('blur', () => {
    if (state.started && !state.submitted) {
      state.focusLost++;
      
      // Show focus warning in sidebar
      focusAlert.textContent = '⚠️ Focus lost';
      focusAlert.classList.remove('secure');
      focusAlert.classList.add('alert');
      
      // Show fullscreen warning after brief delay
      if (!state.warningShown) {
        setTimeout(() => {
          fullscreenNotice.classList.add('visible');
        }, 500);
        
        state.warningShown = true;
      }
      
      // Show warning message in header bar
      if (state.focusLost > 1) {
        warningMessage.textContent = `⚠️ Warning: You have left the exam window ${state.focusLost} times. This would be reported in a real exam.`;
      } else {
        warningMessage.textContent = '⚠️ Warning: You left the exam window. This would be reported in a real exam.';
      }
    }
  });
  
  window.addEventListener('focus', () => {
    if (state.started && !state.submitted) {
      // Restore focus indicator
      focusAlert.textContent = 'Focus maintained';
      focusAlert.classList.add('secure');
      focusAlert.classList.remove('alert');
      
      // Close fullscreen warning if visible
      fullscreenNotice.classList.remove('visible');
      state.warningShown = false;
    }
  });
}

/* RENDER REVIEW ANSWERS */
function renderReviewAnswers() {
  answerReviewArea.innerHTML = '';
  
  // Create review of all questions and answers
  QUESTIONS.forEach((q, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.style.marginBottom = '20px';
    questionDiv.style.padding = '14px';
    questionDiv.style.borderRadius = '6px';
    questionDiv.style.background = '#f9fafc';
    
    // Question text
    const qText = document.createElement('div');
    qText.style.fontWeight = '600';
    qText.textContent = q.q;
    questionDiv.appendChild(qText);
    
    // Your answer
    const answerDiv = document.createElement('div');
    answerDiv.style.marginTop = '8px';
    
    // Different handling based on question type
    if (q.type === 'text') {
      answerDiv.innerHTML = `<div>Your answer: <span style="font-style:italic">${state.answers[q.id] || 'Not answered'}</span></div>`;
    } else {
      const userAnswer = state.answers[q.id] !== undefined ? q.choices[state.answers[q.id]] : 'Not answered';
      const correctAnswer = q.choices[q.answer];
      
      answerDiv.innerHTML = `
        <div>Your answer: <span style="font-weight:600;color:${state.answers[q.id] === q.answer ? '#22c55e' : '#ef4444'}">${userAnswer}</span></div>
        <div style="margin-top:4px">Correct answer: <span style="font-weight:600;color:#22c55e">${correctAnswer}</span></div>
      `;
    }
    
    questionDiv.appendChild(answerDiv);
    answerReviewArea.appendChild(questionDiv);
  });
}

function autoSubmit(timeout = false) {
  if (state.submitted) return;
  
  state.submitted = true;
  state.started = false;
  
  if (state.timer) clearInterval(state.timer);
  
  // Calculate results
  let correct = 0, attempted = 0, incorrect = 0;
  
  QUESTIONS.forEach(q => {
    const a = state.answers[q.id];
    if (a !== undefined) {
      attempted++;
      if (q.type === 'text' || a === q.answer) {
        correct++;
      } else {
        incorrect++;
      }
    }
  });
  
  const total = QUESTIONS.length;
  const pct = Math.round(100 * (correct / total));
  
  // Show finish card
  examCard.style.display = 'none';
  examSidebar.style.display = 'none';
  finishCard.style.display = 'block';
  resultsSidebar.style.display = 'block';
  
  // Update result information
  resInfo.textContent = `Candidate: ${state.candidate} • Index: ${state.indexNo}`;
  resScore.textContent = pct + '%';
  resSummary.textContent = `Correct: ${correct} • Attempted: ${attempted} • Total: ${total}`;
  
  // Update sidebar statistics
  statsAnswered.textContent = attempted;
  statsCorrect.textContent = correct;
  statsIncorrect.textContent = incorrect;
  
  // Generate random submission ID
  submissionId.textContent = Math.floor(Math.random() * 9000000) + 1000000;
  
  save();
  // clearSave(); // We'll keep the data for review capability
}

/* LOAD SAVED STATE */
load();

// Resume from saved state
if (state.step > 1) {
  updateStep(state.step);
  
  // If in exam mode and not submitted, restart timer
  if (state.step === 5 && state.started && !state.submitted) {
    renderGrid();
    renderQuestion();
    startTimer();
  }
  
  // If submitted, show results
  if (state.submitted) {
    autoSubmit(false);
  }
  
  // Populate login fields if available
  if (state.candidate) candName.value = state.candidate;
  if (state.indexNo) candReg.value = state.indexNo;
} else {
  // Start fresh at system check
  updateStep(1);
}

/* UX: prevent accidental refresh and double-submit */
window.addEventListener('beforeunload', function(e) {
  if (state.started && !state.submitted) {
    e.preventDefault();
    e.returnValue = '';
  }
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r')) {
    e.preventDefault();
  }
});

</script>
</body>
</html>
